@page "/configurator"
@using RackConfigurationn.Shared.Models
@inject RackConfigurationn.Client.Services.RackService RackService
@inject NavigationManager Navigation

<div class="container-fluid mt-4" style="max-width: 1600px;">
    <div class="row">

        @* --- SOL PANEL: KONFİGÜRASYON SEÇENEKLERİ --- *@
        <div class="col-md-3">
            <div class="p-3 bg-white shadow-sm rounded border h-100">
                @* Başlık ve Canlı Fiyat *@
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <h5 class="text-primary m-0"><i class="fas fa-sliders-h me-2"></i>Yapılandırma</h5>
                    <span class="badge bg-success fs-5">@CurrentPrice.ToString("C2")</span>
                </div>

                @* 1. Derinlik Seçimi *@
                <label class="form-label fw-bold text-dark small text-uppercase">1. Derinlik</label>
                @if (AllDepths == null)
                {
                    <div class="d-flex align-items-center mb-3">
                        <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                        <small>Yükleniyor...</small>
                    </div>
                }
                else
                {
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        @foreach (var depth in AllDepths)
                        {
                            <button class="btn btn-sm px-3 @(CurrentRack.Depth == depth ? "btn-primary" : "btn-outline-secondary")"
                                    @onclick="(() => SelectDepth(depth))">
                                @depth cm
                            </button>
                        }
                    </div>
                }

                @* 2. Zemin Tipi Seçimi *@
                <label class="form-label fw-bold mt-2 text-dark small text-uppercase">2. Zemin Tipi</label>
                @if (IsLoadingDecks)
                {
                    <div class="text-muted small mb-3">Seçenekler getiriliyor...</div>
                }
                else if (CompatibleDeckOptions != null && CompatibleDeckOptions.Any())
                {
                    <div class="row g-2 scrollable-decks">
                        @foreach (var option in CompatibleDeckOptions)
                        {
                            <div class="col-6">
                                <div class="card h-100 deck-card @(SelectedDeckType == option.DeckType ? "active-deck" : "")"
                                     @onclick="(() => SelectDeckType(option))">

                                    <div class="img-container">
                                        @* Hata durumunda placeholder göster *@
                                        <img src="@option.ImageUrl" onerror="this.src='https://via.placeholder.com/150?text=Resim+Yok'" />
                                    </div>
                                    <div class="card-body p-1 text-center">
                                        <small class="fw-bold" style="font-size: 0.7rem;">@option.DeckType</small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-warning py-2 small">Bu derinlik için uygun parça bulunamadı.</div>
                }

                @* Kaydet Butonu *@
                <div class="mt-4 pt-3 border-top">
                    <button class="btn btn-success w-100 py-2 fw-bold shadow-sm" @onclick="SaveOrder" disabled="@(!CurrentRack.ShelfUnits.Any())">
                        <i class="fas fa-shopping-cart me-2"></i>Siparişi Tamamla
                    </button>
                </div>
            </div>
        </div>

        @* --- SAĞ PANEL: CANLI TASARIM ALANI (VISUALIZER) --- *@
        <div class="col-md-9">
            <div class="p-0 bg-white shadow-sm rounded border h-100 d-flex flex-column overflow-hidden position-relative">

                @* Üst Bilgi Barı *@
                <div class="d-flex justify-content-between align-items-center p-2 bg-light border-bottom small text-muted">
                    <span><i class="fas fa-info-circle me-1"></i>Rafı düzenlemek için fareyi üzerine getirin ve <i class="fas fa-pen text-primary"></i> ikonuna tıklayın.</span>
                    <div>
                        <span class="me-3 fw-bold"><i class="fas fa-ruler-horizontal"></i> Toplam: @CurrentRack.TotalWidth cm</span>
                        <span class="fw-bold"><i class="fas fa-layer-group"></i> Ünite: @CurrentRack.ShelfUnits.Count</span>
                    </div>
                </div>

                @* Çizim Alanı (Drawing Area) *@
                @* CloseEditMenu: Boşluğa tıklayınca menüyü kapatır *@
                <div class="drawing-area flex-grow-1 d-flex align-items-end overflow-auto" @onclick="CloseEditMenu">

                    @* Başlangıç Direği *@
                    <div class="post post-start"></div>

                    @* Üniteleri Döngü ile Çiz *@
                    @foreach (var unit in CurrentRack.ShelfUnits)
                    {
                        @* stopPropagation: Üniteye tıklayınca boşluğa tıklamış gibi algılayıp menüyü kapatmasın *@
                        <div class="rack-section" style="width: @(unit.UnitWidth)px; height: @(unit.Height)px;" @onclick:stopPropagation="true">

                            @* Düzenle Butonu (Hover ile çıkar) *@
                            <button class="btn btn-sm btn-light border shadow-sm edit-trigger"
                                    @onclick="(() => OpenEditMenu(unit))">
                                <i class="fas fa-pen text-primary"></i> Düzenle
                            </button>

                            @* POPUP MENÜ (Topregal Tarzı) *@
                            @if (EditingUnit == unit)
                            {
                                <div class="edit-popup shadow rounded border">
                                    <div class="popup-header">
                                        <span>Raf Düzenle</span>
                                        <button class="btn-close btn-close-white small" @onclick="CloseEditMenu"></button>
                                    </div>
                                    <div class="popup-body">
                                        @* Yükseklik *@
                                        <div class="mb-2">
                                            <label class="small text-muted fw-bold">Yükseklik</label>
                                            <select class="form-select form-select-sm" value="@unit.Height" @onchange="@(e => UpdateUnitHeight(unit, e.Value))">
                                                <option value="200">200 cm</option>
                                                <option value="250">250 cm</option>
                                                <option value="300">300 cm</option>
                                            </select>
                                        </div>
                                        @* Genişlik *@
                                        <div class="mb-2">
                                            <label class="small text-muted fw-bold">Genişlik</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="w_@unit.Id" id="w110_@unit.Id" checked="@(unit.UnitWidth == 110)" @onchange="@(() => UpdateUnitWidth(unit, 110))">
                                                <label class="btn btn-outline-primary btn-sm" for="w110_@unit.Id">110</label>
                                                <input type="radio" class="btn-check" name="w_@unit.Id" id="w220_@unit.Id" checked="@(unit.UnitWidth == 220)" @onchange="@(() => UpdateUnitWidth(unit, 220))">
                                                <label class="btn btn-outline-primary btn-sm" for="w220_@unit.Id">220</label>
                                            </div>
                                        </div>
                                        @* Kat Sayısı *@
                                        <div class="mb-2">
                                            <label class="small text-muted fw-bold">Kat Sayısı</label>
                                            <div class="input-group input-group-sm">
                                                <button class="btn btn-outline-secondary" @onclick="(() => ChangeLevels(unit, -1))">-</button>
                                                <span class="form-control text-center bg-white">@unit.NumberOfDecks</span>
                                                <button class="btn btn-outline-secondary" @onclick="(() => ChangeLevels(unit, 1))">+</button>
                                            </div>
                                        </div>
                                        <hr class="my-2" />
                                        <button class="btn btn-outline-danger btn-sm w-100" @onclick="(() => DeleteUnit(unit))">
                                            <i class="fas fa-trash-alt me-1"></i> Kaldır
                                        </button>
                                    </div>
                                    <div class="popup-arrow"></div>
                                </div>
                            }

                            @* ZEMİN GÖRSELİ VE KİRİŞLER *@
                            @for (int i = 1; i <= unit.NumberOfDecks; i++)
                            {
                                double bottomPos = (unit.Height / (unit.NumberOfDecks + 1)) * i;
                                <div class="beam-container" style="bottom: @(bottomPos)px;">

                                    @* Seçilen Deck Resmi (Texture) *@
                                    @if (!string.IsNullOrEmpty(SelectedDeckImageUrl) && SelectedDeckType != "Without layers")
                                    {
                                        <div class="deck-texture" style="background-image: url('@SelectedDeckImageUrl');"></div>
                                    }

                                    @* Turuncu Kiriş *@
                                    <div class="beam"></div>
                                </div>
                            }

                            <div class="post post-right"></div>
                            <div class="dimension-line">@unit.UnitWidth cm</div>
                        </div>
                    }

                    @* Ekle Butonu *@
                    <div class="add-section-wrapper">
                        <button class="btn btn-primary btn-sm rounded-circle shadow add-btn" @onclick="AddShelfUnit" title="Yeni Bölüm Ekle">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span class="add-label">Ekle</span>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- CSS STYLES --- */

    .drawing-area {
        background-color: #f8f9fa;
        background-image: linear-gradient(#e9ecef 1px, transparent 1px), linear-gradient(90deg, #e9ecef 1px, transparent 1px);
        background-size: 20px 20px;
        padding: 40px;
        min-height: 500px;
        cursor: default;
    }

    .rack-section {
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        margin-right: 0;
        transition: width 0.3s ease, height 0.3s ease;
    }

        .rack-section:hover {
            background: rgba(0, 68, 129, 0.05);
        }

    /* Edit Butonu */
    .edit-trigger {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s, top 0.2s;
        z-index: 20;
        font-size: 0.8rem;
        white-space: nowrap;
        border-radius: 20px;
        padding: 4px 12px;
    }

    .rack-section:hover .edit-trigger {
        opacity: 1;
        top: -30px;
    }

    /* Popup Menü */
    .edit-popup {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 220px;
        background: white;
        z-index: 100;
        animation: fadeIn 0.2s ease-out;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
    }

    .popup-header {
        background: #004481;
        color: white;
        padding: 8px 12px;
        font-size: 0.85rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 4px 4px 0 0;
    }

    .popup-body {
        padding: 15px;
    }

    .popup-arrow {
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #004481;
    }

    /* Direkler ve Kirişler */
    .post, .beam-container {
        pointer-events: none;
    }

    .post {
        width: 6px;
        background: #004481;
        height: 100%;
        position: absolute;
        bottom: 0;
        z-index: 5;
    }

    .post-start {
        position: relative;
        margin-right: -3px;
    }

    .post-right {
        right: -3px;
    }

    .beam-container {
        position: absolute;
        width: 100%;
        height: 20px;
        z-index: 4;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }

    .beam {
        width: 100%;
        height: 12px;
        background: #ff6600;
        border-radius: 2px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        z-index: 10;
    }

    /* YENİ: Doku Kaplaması */
    .deck-texture {
        width: 100%;
        height: 6px;
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        border-radius: 2px 2px 0 0;
        z-index: 5;
        margin-bottom: -1px;
    }

    .dimension-line {
        position: absolute;
        bottom: -25px;
        width: 100%;
        text-align: center;
        font-size: 11px;
        border-top: 1px solid #999;
        color: #666;
    }

        .dimension-line:before, .dimension-line:after {
            content: "";
            position: absolute;
            top: -3px;
            width: 1px;
            height: 7px;
            background: #999;
        }

        .dimension-line:before {
            left: 0;
        }

        .dimension-line:after {
            right: 0;
        }

    .add-section-wrapper {
        margin-left: 30px;
        margin-bottom: 120px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .add-btn {
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: transform 0.2s;
    }

        .add-btn:hover {
            transform: scale(1.1);
        }

    .add-label {
        font-size: 0.75rem;
        color: #666;
        margin-top: 5px;
        font-weight: bold;
    }

    .deck-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        border-color: #dee2e6;
    }

        .deck-card:hover {
            transform: translateY(-3px);
            border-color: #aaa;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

    .active-deck {
        border-color: #004481 !important;
        background-color: #eef5fa;
    }

    .img-container {
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        padding: 5px;
    }

        .img-container img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

    .scrollable-decks {
        max-height: calc(100vh - 450px);
        overflow-y: auto;
    }

    /* Escape edilen keyframes */
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translate(-50%, -10px);
        }

        to {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    }
</style>

@code {
    // --- STATE ---
    private Rack CurrentRack = new Rack { ShelfUnits = new List<ShelfUnit>() };
    private ShelfUnit? EditingUnit = null;

    private List<double>? AllDepths;
    private List<DeckOption>? CompatibleDeckOptions;

    private string SelectedDeckType = "";
    private string SelectedDeckImageUrl = ""; // Zemin görseli
    private double CurrentPrice = 0;

    private bool IsLoadingDecks = false;

    protected override async Task OnInitializedAsync()
    {
        AllDepths = await RackService.GetAllDepthsAsync();
        CurrentRack.CreatedDateTime = DateTime.Now;
        CurrentRack.TotalHeight = 300;

        if (AllDepths != null && AllDepths.Any())
        {
            await SelectDepth(AllDepths.OrderBy(d => d).First());
        }
        else
        {
            CurrentRack.Depth = 40; AddShelfUnit();
        }
    }

    // --- POPUP MENU MANTIĞI ---
    private void OpenEditMenu(ShelfUnit unit) { EditingUnit = unit; }
    private void CloseEditMenu() { EditingUnit = null; }

    private async Task UpdateUnitHeight(ShelfUnit unit, object value)
    {
        if (double.TryParse(value.ToString(), out double newHeight)) { unit.Height = newHeight; await UpdatePrice(); }
    }

    private async Task UpdateUnitWidth(ShelfUnit unit, double newWidth)
    {
        unit.UnitWidth = newWidth; await UpdatePrice();
    }

    private async Task ChangeLevels(ShelfUnit unit, int change)
    {
        int newCount = unit.NumberOfDecks + change;
        if (newCount < 1 || newCount > 10) return;

        unit.NumberOfDecks = newCount;

        // Yeni kat eklerken mevcut zemin tipini kullan
        string currentType = unit.Decks.FirstOrDefault()?.DeckType ?? (string.IsNullOrEmpty(SelectedDeckType) ? "Without layers" : SelectedDeckType);

        if (change > 0) unit.Decks.Add(new Deck { DeckType = currentType, level = newCount });
        else { var last = unit.Decks.LastOrDefault(); if (last != null) unit.Decks.Remove(last); }

        await UpdatePrice();
    }

    private async Task DeleteUnit(ShelfUnit unit) { CurrentRack.ShelfUnits.Remove(unit); EditingUnit = null; await UpdatePrice(); }

    // --- SEÇİM MANTIĞI ---
    private async Task SelectDepth(double depth)
    {
        CurrentRack.Depth = depth;

        // <--- YENİ EKLENEN KISIM: MEVCUT ÜNİTELERİ GÜNCELLEME --->
        // Derinlik değişince, ekrandaki ünitelerin de derinliği değişmeli.
        // Yoksa fiyat hesaplarken eski (veya 0) derinlik kullanır ve hata verir.
        foreach (var unit in CurrentRack.ShelfUnits)
        {
            unit.Depth = (int)depth;
        }
        // <------------------------------------------------------->

        SelectedDeckType = "";
        SelectedDeckImageUrl = "";
        IsLoadingDecks = true;

        CompatibleDeckOptions = await RackService.GetCompatibleDeckOptionsAsync(depth);
        IsLoadingDecks = false;

        if (!CurrentRack.ShelfUnits.Any()) AddShelfUnit();
        else await UpdatePrice();
    }

    private async Task SelectDeckType(DeckOption option)
    {
        SelectedDeckType = option.DeckType;
        SelectedDeckImageUrl = option.ImageUrl; // Görseli kaydet

        foreach (var unit in CurrentRack.ShelfUnits)
            foreach (var deck in unit.Decks)
                deck.DeckType = option.DeckType;
        await UpdatePrice();
    }

    private void AddShelfUnit()
    {
        var newUnit = new ShelfUnit
        {
            Height = CurrentRack.TotalHeight > 0 ? CurrentRack.TotalHeight : 300,
            UnitWidth = 220,
            NumberOfDecks = 3,

            // <--- YENİ EKLENEN KISIM: DEPTH ATAMASI --->
            // Backend bu bilgiyi kullanarak fiyat hesaplayacak.
            Depth = (int)CurrentRack.Depth,
            // <--------------------------------------->

            Decks = new List<Deck>()
        };
        string type = string.IsNullOrEmpty(SelectedDeckType) ? "Without layers" : SelectedDeckType;
        for (int i = 1; i <= 3; i++) newUnit.Decks.Add(new Deck { DeckType = type, level = i });

        CurrentRack.ShelfUnits.Add(newUnit);
        _ = UpdatePrice();
    }

    private async Task UpdatePrice() { CurrentPrice = await RackService.CalculatePriceAsync(CurrentRack); StateHasChanged(); }
    private async Task SaveOrder() { bool success = await RackService.CreateRackAsync(CurrentRack); if (success) Console.WriteLine("Sipariş Başarılı!"); }
}